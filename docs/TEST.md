# Testing the story-to-block Integration

This guide walks through verifying that `story-to-block` is correctly integrated with the Storybook starter project.

## Prerequisites

Make sure dependencies are installed for both projects:

```bash
# From the project root
npm install

# From the story-to-block folder
cd story-to-block
npm install
npm run build
cd ..
```

## 1. Run the story-to-block Unit Tests

```bash
cd story-to-block
npx vitest run
```

**Expected output:** 5 test files, 44 tests passing.

Tests cover:
- Config validation (required fields, name/slug pairing, unknown categories)
- `tokens.css` generation (variable names, grouping, prefix)
- `tokens.wp.css` generation (var() mappings for slugged tokens, hardcoded for others)
- `theme.json` generation (only named tokens, custom categories, zIndex excluded)
- Full integration (generate all files from a test config, verify contents)

## 2. Run the Generator

From the project root:

```bash
npm run generate
```

**Expected output:**

```
story-to-block: generated files:
  src/styles/tokens.css (2594 bytes)
  dist/wp/tokens.wp.css (3328 bytes)
  dist/wp/theme.json (3538 bytes)
  dist/wp/integrate.php (862 bytes)
```

### Verify tokens.css

Open `src/styles/tokens.css` and check:

- [ ] File starts with `/* Auto-generated by story-to-block — do not edit manually */`
- [ ] All variables use the `--prefix-` prefix
- [ ] Variables are grouped by category (Colors, Spacing, Font Families, etc.)
- [ ] All values match what's in `stb.config.json`
- [ ] No `var()` wrappers — all values are hardcoded

### Verify tokens.wp.css

Open `dist/wp/tokens.wp.css` and check:

- [ ] Tokens with `slug` in the config use `var(--wp--preset--*--{slug}, fallback)` syntax
- [ ] Tokens without `slug` use hardcoded values (same as tokens.css)
- [ ] `fontWeight`, `radius`, `shadow`, `transition`, `zIndex` categories are always hardcoded
- [ ] Example: `--prefix-color-primary: var(--wp--preset--color--primary, #0073aa);`
- [ ] Example: `--prefix-color-primary-hover: #005a87;`

### Verify theme.json

Open `dist/wp/theme.json` and check:

- [ ] Has `"$schema"` and `"version": 3`
- [ ] `settings.color.palette` contains only colors that have `name` + `slug` in config
- [ ] `settings.spacing.spacingSizes` contains spacing entries with slugs
- [ ] `settings.typography.fontFamilies` and `settings.typography.fontSizes` are populated
- [ ] `settings.custom` contains `fontWeight`, `lineHeight`, `radius`, `shadow`, `transition`
- [ ] No `zIndex` anywhere in the file
- [ ] Colors like `primary-hover` (no name/slug) are NOT in the palette

### Verify integrate.php

Open `dist/wp/integrate.php` and check:

- [ ] Contains `wp_theme_json_data_default` filter
- [ ] References `__DIR__ . '/theme.json'`
- [ ] Has `ABSPATH` guard

## 3. Run the Full Build

```bash
npm run build
```

**Expected output:** The build runs four steps in sequence:

1. `generate` — writes `src/styles/tokens.css` + `dist/wp/*`
2. `build:lib` — Vite compiles React components to `dist/`
3. `build:css` — copies individual CSS files to `dist/css/`, creates `dist/styles.css`
4. `build:wp` — re-generates `dist/wp/*` (because step 2 wipes `dist/`)

After the build, verify the dist folder contains everything:

```bash
ls dist/
# Expected: css/ wp/ index.js index.d.ts styles.css

ls dist/css/
# Expected: tokens.css reset.css Button.css Card.css

ls dist/wp/
# Expected: tokens.wp.css theme.json integrate.php
```

## 4. Test Storybook Dev Server

```bash
npm run dev
```

- [ ] Storybook starts without errors on port 6006
- [ ] Card component renders with correct styles (colors, spacing, border radius from tokens)
- [ ] Button component renders with correct styles
- [ ] Changing a value in `stb.config.json` and restarting `npm run dev` updates the component styles

## 5. Test Dry Run Mode

```bash
node story-to-block/dist/cli.js generate --dry-run
```

- [ ] Outputs all four generated files to stdout (tokens.css, tokens.wp.css, theme.json, integrate.php)
- [ ] Does NOT write any files to disk
- [ ] Each section is separated by `=== filename ===` headers

## 6. Test Config Validation

Test that invalid configs produce clear error messages:

### Missing prefix

```bash
echo '{"tokens":{"color":{"x":{"value":"#000"}}}}' > /tmp/bad-config.json
node story-to-block/dist/cli.js generate --config /tmp/bad-config.json
```

Expected: `"prefix" is required`

### Token with name but no slug

```bash
echo '{"prefix":"t","tokens":{"color":{"x":{"value":"#000","name":"X"}}}}' > /tmp/bad-config.json
node story-to-block/dist/cli.js generate --config /tmp/bad-config.json
```

Expected: `has "name" but no "slug"`

### Token missing value

```bash
echo '{"prefix":"t","tokens":{"color":{"x":{}}}}' > /tmp/bad-config.json
node story-to-block/dist/cli.js generate --config /tmp/bad-config.json
```

Expected: `missing a "value"`

### Config file not found

```bash
node story-to-block/dist/cli.js generate --config /tmp/nonexistent.json
```

Expected: `Config file not found`

## 7. Test Token Changes

Verify that changing the config updates all outputs consistently:

1. Open `stb.config.json`
2. Change `color.primary.value` from `#0073aa` to `#ff0000`
3. Run `npm run generate`
4. Check that all three files updated:
   - `src/styles/tokens.css` → `--prefix-color-primary: #ff0000;`
   - `dist/wp/tokens.wp.css` → `--prefix-color-primary: var(--wp--preset--color--primary, #ff0000);`
   - `dist/wp/theme.json` → `"color": "#ff0000"` in the palette
5. Revert the change back to `#0073aa`

## 8. Test Prefix Change

1. Open `stb.config.json`
2. Change `"prefix": "prefix"` to `"prefix": "mylib"`
3. Run `npm run generate`
4. Check that `src/styles/tokens.css` uses `--mylib-*` variables
5. Check that `dist/wp/tokens.wp.css` uses `--mylib-*` variables
6. Revert the change back to `"prefix"` (component CSS files still reference `--prefix-*`)

> **Note:** Changing the prefix in the config updates CSS variable names but not component CSS class names or variable references. Those require a manual find-and-replace across component files.

## Summary Checklist

| Test | Status |
|------|--------|
| Unit tests pass (44/44) | |
| Generator produces 4 files | |
| tokens.css has correct hardcoded variables | |
| tokens.wp.css has correct var() mappings | |
| theme.json contains only named/slugged tokens | |
| integrate.php has correct PHP filter | |
| Full build produces complete dist/ | |
| Storybook dev server works | |
| Dry run outputs to stdout only | |
| Config validation catches errors | |
| Token value changes propagate to all files | |
| Prefix change updates variable names | |
